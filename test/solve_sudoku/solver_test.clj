(ns solve-sudoku.solver-test
  (:use clojure.test
        solve-sudoku.solver))

(defn valid-seq?
  [s]
  (and (not-any? zero? s)
       (= (count (distinct s)) (count s))))

(defn valid-solution?
  [solution]
  (if (not (vector? solution))
    false
    (let [rows solution
          cols (apply map vector solution)
          squares (for [square-top (range 0 9 3)
                        square-left (range 0 9 3)]
                    (mapcat (fn [row] (subvec row square-left (+ square-left 3)))
                            (subvec solution square-top (+ square-top 3))))]
      (and (every? valid-seq? rows)
           (every? valid-seq? cols)
           (every? valid-seq? squares)))))

(deftest test-solve-puzzle
  (testing "Puzzles with a solution"
    (is (valid-solution? (solve-puzzle [[1 0 0 9 0 7 0 0 3]
                                        [0 8 0 0 0 0 0 7 0]
                                        [0 0 9 0 0 0 6 0 0]
                                        [0 0 7 2 0 9 4 0 0]
                                        [4 1 0 0 0 0 0 9 5]
                                        [0 0 8 5 0 4 3 0 0]
                                        [0 0 3 0 0 0 7 0 0]
                                        [0 5 0 0 0 0 0 4 0]
                                        [2 0 0 8 0 6 0 0 9]])))
    (is (valid-solution? (solve-puzzle [[0 0 0 3 0 2 0 0 0]
                                        [0 5 0 7 9 8 0 3 0]
                                        [0 0 7 0 0 0 8 0 0]
                                        [0 0 8 6 0 7 3 0 0]
                                        [0 7 0 0 0 0 0 6 0]
                                        [0 0 3 5 0 4 1 0 0]
                                        [0 0 5 0 0 0 6 0 0]
                                        [0 2 0 4 1 9 0 5 0]
                                        [0 0 0 8 0 6 0 0 0]])))
    (is (valid-solution? (solve-puzzle [[0 0 0 8 0 0 0 0 6]
                                        [0 0 1 6 2 0 4 3 0]
                                        [4 0 0 0 7 1 0 0 2]
                                        [0 0 7 2 0 0 0 8 0]
                                        [0 0 0 0 1 0 0 0 0]
                                        [0 1 0 0 0 6 2 0 0]
                                        [1 0 0 7 3 0 0 0 4]
                                        [0 2 6 0 4 8 1 0 0]
                                        [3 0 0 0 0 5 0 0 0]])))
    (is (valid-solution? (solve-puzzle [[3 0 5 0 0 4 0 7 0]
                                        [0 7 0 0 0 0 0 0 1]
                                        [0 4 0 9 0 0 0 3 0]
                                        [4 0 0 0 5 1 0 0 6]
                                        [0 9 0 0 0 0 0 4 0]
                                        [2 0 0 8 4 0 0 0 7]
                                        [0 2 0 0 0 7 0 6 0]
                                        [8 0 0 0 0 0 0 9 0]
                                        [0 6 0 4 0 0 2 0 8]])))
    (is (valid-solution? (solve-puzzle [[0 0 0 7 0 0 3 0 0]
                                        [0 6 0 0 0 0 5 7 0]
                                        [0 7 3 8 0 0 4 1 0]
                                        [0 0 9 2 8 0 0 0 0]
                                        [5 0 0 0 0 0 0 0 9]
                                        [0 0 0 0 9 3 6 0 0]
                                        [0 9 8 0 0 7 1 5 0]
                                        [0 5 4 0 0 0 0 6 0]
                                        [0 0 1 0 0 9 0 0 0]])))
    (is (valid-solution? (solve-puzzle [[0 0 0 6 0 0 0 0 4]
                                        [0 3 0 0 9 0 0 2 0]
                                        [0 6 0 8 0 0 7 0 0]
                                        [0 0 5 0 6 0 0 0 1]
                                        [6 7 0 3 0 1 0 5 8]
                                        [9 0 0 0 5 0 4 0 0]
                                        [0 0 6 0 0 3 0 9 0]
                                        [0 1 0 0 8 0 0 6 0]
                                        [2 0 0 0 0 6 0 0 0]])))
    (is (valid-solution? (solve-puzzle [[8 0 0 0 0 1 0 4 0]
                                        [2 0 6 0 9 0 0 1 0]
                                        [0 0 9 0 0 6 0 8 0]
                                        [1 2 4 0 0 0 0 0 9]
                                        [0 0 0 0 0 0 0 0 0]
                                        [9 0 0 0 0 0 8 2 4]
                                        [0 5 0 4 0 0 1 0 0]
                                        [0 8 0 0 7 0 2 0 5]
                                        [0 9 0 5 0 0 0 0 7]]))))
  (testing "Puzzles with no solution"
    (is (nil? (solve-puzzle [[1 0 0 9 0 7 0 0 3]
                             [0 8 0 0 0 0 0 7 0]
                             [0 0 9 0 0 0 6 0 0]
                             [0 0 7 2 0 9 4 0 0]
                             [4 1 0 0 0 0 0 9 5]
                             [0 0 8 5 0 4 3 0 0]
                             [0 0 3 0 0 3 7 0 0]
                             [0 5 0 0 0 0 0 4 0]
                             [2 0 0 8 0 6 0 0 9]])))
    (is (nil? (solve-puzzle [[8 0 0 0 0 1 0 4 0]
                             [2 0 6 0 9 0 0 1 0]
                             [0 0 9 0 0 6 0 8 0]
                             [1 2 4 0 0 0 0 0 9]
                             [0 0 0 0 0 0 0 9 0]
                             [9 0 0 0 0 0 8 2 4]
                             [0 5 0 4 0 0 1 0 0]
                             [0 8 0 0 7 0 2 0 5]
                             [0 9 0 5 0 0 0 0 7]])))
    (is (nil? (solve-puzzle [[0 0 0 6 0 0 0 0 4]
                             [0 3 0 0 9 0 0 2 0]
                             [0 6 0 8 0 0 7 0 0]
                             [0 0 5 0 6 0 0 0 1]
                             [6 7 0 3 0 1 0 5 8]
                             [9 0 0 0 5 0 4 0 0]
                             [0 0 6 0 0 3 0 9 8]
                             [0 1 0 0 8 0 0 6 0]
                             [2 0 0 0 0 6 0 0 0]])))))

(deftest test-str-to-puzzle
  (testing "String to puzzles conversion"
    (is (= (str-to-puzzle (str "1 0 0 9 0 7 0 0 3\n"
                               "0 8 0 0 0 0 0 7 0\n"
                               "0 0 9 0 0 0 6 0 0\n"
                               "0 0 7 2 0 9 4 0 0\n"
                               "4 1 0 0 0 0 0 9 5\n"
                               "0 0 8 5 0 4 3 0 0\n"
                               "0 0 3 0 0 0 7 0 0\n"
                               "0 5 0 0 0 0 0 4 0\n"
                               "2 0 0 8 0 6 0 0 9\n"))
           [[1 0 0 9 0 7 0 0 3]
            [0 8 0 0 0 0 0 7 0]
            [0 0 9 0 0 0 6 0 0]
            [0 0 7 2 0 9 4 0 0]
            [4 1 0 0 0 0 0 9 5]
            [0 0 8 5 0 4 3 0 0]
            [0 0 3 0 0 0 7 0 0]
            [0 5 0 0 0 0 0 4 0]
            [2 0 0 8 0 6 0 0 9]]))
    (is (= (str-to-puzzle (str "0 0 0 3 0 2 0 0 0\n"
                               "0 5 0 7 9 8 0 3 0\n"
                               "0 0 7 0 0 0 8 0 0\n"
                               "0 0 8 6 0 7 3 0 0\n"
                               "0 7 0 0 0 0 0 6 0\n"
                               "0 0 3 5 0 4 1 0 0\n"
                               "0 0 5 0 0 0 6 0 0\n"
                               "0 2 0 4 1 9 0 5 0\n"
                               "0 0 0 8 0 6 0 0 0\n"))
           [[0 0 0 3 0 2 0 0 0]
            [0 5 0 7 9 8 0 3 0]
            [0 0 7 0 0 0 8 0 0]
            [0 0 8 6 0 7 3 0 0]
            [0 7 0 0 0 0 0 6 0]
            [0 0 3 5 0 4 1 0 0]
            [0 0 5 0 0 0 6 0 0]
            [0 2 0 4 1 9 0 5 0]
            [0 0 0 8 0 6 0 0 0]]))
    (is (= (str-to-puzzle (str "0 0 0 8 0 0 0 0 6\n"
                               "0 0 1 6 2 0 4 3 0\n"
                               "4 0 0 0 7 1 0 0 2\n"
                               "0 0 7 2 0 0 0 8 0\n"
                               "0 0 0 0 1 0 0 0 0\n"
                               "0 1 0 0 0 6 2 0 0\n"
                               "1 0 0 7 3 0 0 0 4\n"
                               "0 2 6 0 4 8 1 0 0\n"
                               "3 0 0 0 0 5 0 0 0\n"))
           [[0 0 0 8 0 0 0 0 6]
            [0 0 1 6 2 0 4 3 0]
            [4 0 0 0 7 1 0 0 2]
            [0 0 7 2 0 0 0 8 0]
            [0 0 0 0 1 0 0 0 0]
            [0 1 0 0 0 6 2 0 0]
            [1 0 0 7 3 0 0 0 4]
            [0 2 6 0 4 8 1 0 0]
            [3 0 0 0 0 5 0 0 0]]))
    (is (= (str-to-puzzle (str "3 0 5 0 0 4 0 7 0\n"
                               "0 7 0 0 0 0 0 0 1\n"
                               "0 4 0 9 0 0 0 3 0\n"
                               "4 0 0 0 5 1 0 0 6\n"
                               "0 9 0 0 0 0 0 4 0\n"
                               "2 0 0 8 4 0 0 0 7\n"
                               "0 2 0 0 0 7 0 6 0\n"
                               "8 0 0 0 0 0 0 9 0\n"
                               "0 6 0 4 0 0 2 0 8\n"))

           [[3 0 5 0 0 4 0 7 0]
            [0 7 0 0 0 0 0 0 1]
            [0 4 0 9 0 0 0 3 0]
            [4 0 0 0 5 1 0 0 6]
            [0 9 0 0 0 0 0 4 0]
            [2 0 0 8 4 0 0 0 7]
            [0 2 0 0 0 7 0 6 0]
            [8 0 0 0 0 0 0 9 0]
            [0 6 0 4 0 0 2 0 8]]))
    (is (= (str-to-puzzle (str "0 0 0 7 0 0 3 0 0\n"
                               "0 6 0 0 0 0 5 7 0\n"
                               "0 7 3 8 0 0 4 1 0\n"
                               "0 0 9 2 8 0 0 0 0\n"
                               "5 0 0 0 0 0 0 0 9\n"
                               "0 0 0 0 9 3 6 0 0\n"
                               "0 9 8 0 0 7 1 5 0\n"
                               "0 5 4 0 0 0 0 6 0\n"
                               "0 0 1 0 0 9 0 0 0\n"))
           [[0 0 0 7 0 0 3 0 0]
            [0 6 0 0 0 0 5 7 0]
            [0 7 3 8 0 0 4 1 0]
            [0 0 9 2 8 0 0 0 0]
            [5 0 0 0 0 0 0 0 9]
            [0 0 0 0 9 3 6 0 0]
            [0 9 8 0 0 7 1 5 0]
            [0 5 4 0 0 0 0 6 0]
            [0 0 1 0 0 9 0 0 0]]))
    (is (= (str-to-puzzle (str "0 0 0 6 0 0 0 0 4\n"
                               "0 3 0 0 9 0 0 2 0\n"
                               "0 6 0 8 0 0 7 0 0\n"
                               "0 0 5 0 6 0 0 0 1\n"
                               "6 7 0 3 0 1 0 5 8\n"
                               "9 0 0 0 5 0 4 0 0\n"
                               "0 0 6 0 0 3 0 9 0\n"
                               "0 1 0 0 8 0 0 6 0\n"
                               "2 0 0 0 0 6 0 0 0\n"))
           [[0 0 0 6 0 0 0 0 4]
            [0 3 0 0 9 0 0 2 0]
            [0 6 0 8 0 0 7 0 0]
            [0 0 5 0 6 0 0 0 1]
            [6 7 0 3 0 1 0 5 8]
            [9 0 0 0 5 0 4 0 0]
            [0 0 6 0 0 3 0 9 0]
            [0 1 0 0 8 0 0 6 0]
            [2 0 0 0 0 6 0 0 0]]))))

(deftest test-puzzle-to-str
  (testing "Puzzle to string conversion"
    (is (= (puzzle-to-str [[1 0 0 9 0 7 0 0 3]
                           [0 8 0 0 0 0 0 7 0]
                           [0 0 9 0 0 0 6 0 0]
                           [0 0 7 2 0 9 4 0 0]
                           [4 1 0 0 0 0 0 9 5]
                           [0 0 8 5 0 4 3 0 0]
                           [0 0 3 0 0 0 7 0 0]
                           [0 5 0 0 0 0 0 4 0]
                           [2 0 0 8 0 6 0 0 9]])
           (str "+---+---+---+\n"
                "|1  |9 7|  3|\n"
                "| 8 |   | 7 |\n"
                "|  9|   |6  |\n"
                "+---+---+---+\n"
                "|  7|2 9|4  |\n"
                "|41 |   | 95|\n"
                "|  8|5 4|3  |\n"
                "+---+---+---+\n"
                "|  3|   |7  |\n"
                "| 5 |   | 4 |\n"
                "|2  |8 6|  9|\n"
                "+---+---+---+\n")))
    (is (= (puzzle-to-str [[0 0 0 3 0 2 0 0 0]
                           [0 5 0 7 9 8 0 3 0]
                           [0 0 7 0 0 0 8 0 0]
                           [0 0 8 6 0 7 3 0 0]
                           [0 7 0 0 0 0 0 6 0]
                           [0 0 3 5 0 4 1 0 0]
                           [0 0 5 0 0 0 6 0 0]
                           [0 2 0 4 1 9 0 5 0]
                           [0 0 0 8 0 6 0 0 0]])
           (str "+---+---+---+\n"
                "|   |3 2|   |\n"
                "| 5 |798| 3 |\n"
                "|  7|   |8  |\n"
                "+---+---+---+\n"
                "|  8|6 7|3  |\n"
                "| 7 |   | 6 |\n"
                "|  3|5 4|1  |\n"
                "+---+---+---+\n"
                "|  5|   |6  |\n"
                "| 2 |419| 5 |\n"
                "|   |8 6|   |\n"
                "+---+---+---+\n")))
    (is (= (puzzle-to-str [[0 0 0 8 0 0 0 0 6]
                           [0 0 1 6 2 0 4 3 0]
                           [4 0 0 0 7 1 0 0 2]
                           [0 0 7 2 0 0 0 8 0]
                           [0 0 0 0 1 0 0 0 0]
                           [0 1 0 0 0 6 2 0 0]
                           [1 0 0 7 3 0 0 0 4]
                           [0 2 6 0 4 8 1 0 0]
                           [3 0 0 0 0 5 0 0 0]])
           (str "+---+---+---+\n"
                "|   |8  |  6|\n"
                "|  1|62 |43 |\n"
                "|4  | 71|  2|\n"
                "+---+---+---+\n"
                "|  7|2  | 8 |\n"
                "|   | 1 |   |\n"
                "| 1 |  6|2  |\n"
                "+---+---+---+\n"
                "|1  |73 |  4|\n"
                "| 26| 48|1  |\n"
                "|3  |  5|   |\n"
                "+---+---+---+\n")))
    (is (= (puzzle-to-str [[3 0 5 0 0 4 0 7 0]
                           [0 7 0 0 0 0 0 0 1]
                           [0 4 0 9 0 0 0 3 0]
                           [4 0 0 0 5 1 0 0 6]
                           [0 9 0 0 0 0 0 4 0]
                           [2 0 0 8 4 0 0 0 7]
                           [0 2 0 0 0 7 0 6 0]
                           [8 0 0 0 0 0 0 9 0]
                           [0 6 0 4 0 0 2 0 8]])
           (str "+---+---+---+\n"
                "|3 5|  4| 7 |\n"
                "| 7 |   |  1|\n"
                "| 4 |9  | 3 |\n"
                "+---+---+---+\n"
                "|4  | 51|  6|\n"
                "| 9 |   | 4 |\n"
                "|2  |84 |  7|\n"
                "+---+---+---+\n"
                "| 2 |  7| 6 |\n"
                "|8  |   | 9 |\n"
                "| 6 |4  |2 8|\n"
                "+---+---+---+\n")))
    (is (= (puzzle-to-str [[0 0 0 7 0 0 3 0 0]
                           [0 6 0 0 0 0 5 7 0]
                           [0 7 3 8 0 0 4 1 0]
                           [0 0 9 2 8 0 0 0 0]
                           [5 0 0 0 0 0 0 0 9]
                           [0 0 0 0 9 3 6 0 0]
                           [0 9 8 0 0 7 1 5 0]
                           [0 5 4 0 0 0 0 6 0]
                           [0 0 1 0 0 9 0 0 0]])
           (str "+---+---+---+\n"
                "|   |7  |3  |\n"
                "| 6 |   |57 |\n"
                "| 73|8  |41 |\n"
                "+---+---+---+\n"
                "|  9|28 |   |\n"
                "|5  |   |  9|\n"
                "|   | 93|6  |\n"
                "+---+---+---+\n"
                "| 98|  7|15 |\n"
                "| 54|   | 6 |\n"
                "|  1|  9|   |\n"
                "+---+---+---+\n")))
    (is (= (puzzle-to-str [[0 0 0 6 0 0 0 0 4]
                           [0 3 0 0 9 0 0 2 0]
                           [0 6 0 8 0 0 7 0 0]
                           [0 0 5 0 6 0 0 0 1]
                           [6 7 0 3 0 1 0 5 8]
                           [9 0 0 0 5 0 4 0 0]
                           [0 0 6 0 0 3 0 9 0]
                           [0 1 0 0 8 0 0 6 0]
                           [2 0 0 0 0 6 0 0 0]])
           (str "+---+---+---+\n"
                "|   |6  |  4|\n"
                "| 3 | 9 | 2 |\n"
                "| 6 |8  |7  |\n"
                "+---+---+---+\n"
                "|  5| 6 |  1|\n"
                "|67 |3 1| 58|\n"
                "|9  | 5 |4  |\n"
                "+---+---+---+\n"
                "|  6|  3| 9 |\n"
                "| 1 | 8 | 6 |\n"
                "|2  |  6|   |\n"
                "+---+---+---+\n")))
    (is (= (puzzle-to-str [[1 6 4 9 5 7 2 8 3]
                           [3 8 5 6 2 1 9 7 4]
                           [7 2 9 4 3 8 6 5 1]
                           [5 3 7 2 8 9 4 1 6]
                           [4 1 2 7 6 3 8 9 5]
                           [6 9 8 5 1 4 3 2 7]
                           [8 4 3 1 9 5 7 6 2]
                           [9 5 6 3 7 2 1 4 8]
                           [2 7 1 8 4 6 5 3 9]])
           (str "+---+---+---+\n"
                "|164|957|283|\n"
                "|385|621|974|\n"
                "|729|438|651|\n"
                "+---+---+---+\n"
                "|537|289|416|\n"
                "|412|763|895|\n"
                "|698|514|327|\n"
                "+---+---+---+\n"
                "|843|195|762|\n"
                "|956|372|148|\n"
                "|271|846|539|\n"
                "+---+---+---+\n")))))
